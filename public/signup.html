<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="css/topbar.css">
    <script src="/js/signupTracker.js"></script>
    <script defer src="js/auth-helper.js"></script>
    <link rel="stylesheet" href="css/signup.css">
    <link rel="stylesheet" href="css/profile-menu.css">
</head>
<body>
  <header class="site-topbar">
    <a href="/index.html" class="site-logo" aria-label="Dcout 메인으로 이동">
      <span class="logo-accent">DC</span>
      <span class="logo-divider" aria-hidden="true"></span>
      <span class="logo-rest">OUT</span>
    </a>
  </header>

  <main class="signup-stage">
    <div class="container">
        <div class="signup-form">
            <!-- 이미 가입한 사용자 메시지 -->
            <div id="already-registered" style="display: none;" class="warning-message already-registered">
                <div class="form-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h2>이미 가입한 기록이 있습니다</h2>
                </div>
                <div class="form-content">
                    <p>이 브라우저에서 이미 계정을 만든 기록이 있습니다.</p>
                    <p id="registered-accounts"></p>
                    <div class="form-actions">
                        <button type="button" onclick="goToLogin()" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> 로그인하러 가기
                        </button>
                        <button type="button" onclick="forceSignup()" class="btn btn-secondary">
                            <i class="fas fa-user-plus"></i> 그래도 새 계정 만들기
                        </button>
                        <button type="button" onclick="clearAdvancedHistory()" class="btn btn-danger">
                            <i class="fas fa-trash"></i> 기록 삭제 후 가입
                        </button>
                    </div>
                </div>
            </div>

            <!-- 회원가입 폼 -->
            <div id="signup-form-container" style="display:none;">
                <div class="form-header">
                    <h2>회원가입</h2>
                </div>
                <div class="form-content">
                    <form id="signup-form">
                        <div class="form-group">
                            <label for="username">아이디</label>
                            <input type="text" id="username" name="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">비밀번호</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label for="name">이름</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-user-plus"></i> 회원가입
                            </button>
                            <button type="button" onclick="goToLogin()" class="btn btn-secondary">
                                <i class="fas fa-sign-in-alt"></i> 로그인
                            </button>
                        </div>
                        <div id="result"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
/* --- 브라우저 기록 기반 중복 가입 방지 --- */
const SIGNUP_LIMIT_FALLBACK = 5;
let signupConfig = { limit: SIGNUP_LIMIT_FALLBACK, bypass: false };

document.addEventListener('DOMContentLoaded', async function() {
    await loadSignupConfig();
    await checkAdvancedSignupHistory();
});

async function loadSignupConfig() {
    try {
        const response = await fetch('/api/users/signup/config');
        if (!response.ok) return;
        const data = await response.json();
        if (typeof data.limit === 'number' && data.limit > 0) {
            signupConfig.limit = data.limit;
        }
        signupConfig.bypass = Boolean(data.bypass);
    } catch (error) {
        console.warn('Failed to load signup config, using fallback.', error);
    }
}

// IndexedDB + LocalStorage 확인
async function checkAdvancedSignupHistory() {
    if (signupConfig.bypass) {
        showSignupForm();
        return;
    }
    try {
        // IndexedDB에서 최근 24시간 내 가입 기록 확인
        const recentSignups = window.signupTracker ? await signupTracker.hasRecentSignup(24) : [];
        if (recentSignups && recentSignups.length > 0) {
            const usernames = recentSignups.map(s => s.username);
            document.getElementById('registered-accounts').innerText = `최근 24시간 내 가입: ${usernames.join(', ')}`;
            document.getElementById('signup-form-container').style.display = 'none';
            document.getElementById('already-registered').style.display = 'block';
            return;
        }
        // LocalStorage도 함께 확인
        checkSignupHistory();
    } catch (error) {
        console.error('IndexedDB check failed, fallback to localStorage:', error);
        checkSignupHistory();
    }
}

// LocalStorage 기반 확인
function checkSignupHistory() {
    const registeredAccounts = JSON.parse(localStorage.getItem('registeredAccounts') || '[]');
    if (!signupConfig.bypass && registeredAccounts.length >= signupConfig.limit) {
        document.getElementById('registered-accounts').innerText =
            `최대 ${signupConfig.limit}개 계정까지 가입할 수 있습니다.\n(이미 가입: ${registeredAccounts.join(', ')})`;
        document.getElementById('signup-form-container').style.display = 'none';
        document.getElementById('already-registered').style.display = 'block';
    } else {
        showSignupForm();
    }
}

function showSignupForm() {
    document.getElementById('signup-form-container').style.display = 'block';
    document.getElementById('already-registered').style.display = 'none';
}

function forceSignup() {
    if (confirm('정말로 새 계정을 만드시겠습니까? 기존 계정과 혼동될 수 있습니다.')) {
        showSignupForm();
    }
}

async function clearAdvancedHistory() {
    if (confirm('모든 가입 기록을 삭제하시겠습니까? (복구할 수 없습니다)')) {
        try {
            if (window.signupTracker) await signupTracker.clearHistory();
            localStorage.removeItem('registeredAccounts');
            localStorage.removeItem('signupHistory');
            localStorage.removeItem('token');
            alert('모든 기록이 삭제되었습니다.');
            showSignupForm();
        } catch (error) {
            console.error('Failed to clear IndexedDB:', error);
            localStorage.removeItem('registeredAccounts');
            localStorage.removeItem('signupHistory');
            localStorage.removeItem('token');
            showSignupForm();
        }
    }
}

function goToLogin() {
    window.location.href = '/login.html';
}

/* --- 회원가입 폼 제출 --- */
document.getElementById('signup-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const name = document.getElementById('name').value.trim();
    const result = document.getElementById('result');

    if (!username || !password || !name) {
        result.style.color = "#d9534f";
        result.textContent = "모든 필드를 입력해주세요.";
        return;
    }

    try {
        // signup.html 내부 회원가입 fetch 부분
        const registeredAccounts = JSON.parse(localStorage.getItem('registeredAccounts') || '[]');
        const response = await fetch('/api/users/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // 헤더에 x-registered-accounts 삭제 (한글 문제 해결)
            },
            body: JSON.stringify({ username, password, name, registeredAccounts }) // registeredAccounts를 body에 포함
        });
        const data = await response.json();

        if (response.ok) {
            // 가입 성공 시 브라우저 기록 저장
            if (window.signupTracker) await signupTracker.recordSignup(username);
            // LocalStorage에도 기록
            const registeredAccounts = JSON.parse(localStorage.getItem('registeredAccounts') || '[]');
            if (!registeredAccounts.includes(username)) {
                registeredAccounts.push(username);
                localStorage.setItem('registeredAccounts', JSON.stringify(registeredAccounts));
            }
            result.style.color = "#28a745";
            result.textContent = "회원가입이 완료되었습니다!";
            setTimeout(() => { window.location.href = "/login.html"; }, 1500);
        } else {
            result.style.color = "#d9534f";
            result.textContent = data.error || "회원가입에 실패했습니다.";
        }
    } catch (error) {
        result.style.color = "#d9534f";
        result.textContent = "네트워크 오류가 발생했습니다.";
        console.error(error);
    }
});
</script>
  </main>
<script defer src="js/auth-helper.js"></script>
<script defer src="js/profile-menu.js"></script>
</body>
</html>
