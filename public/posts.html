<!-- public/posts.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>게시판</title>
  <link rel="stylesheet" href="css/posts.css">
  <link rel="stylesheet" href="css/topbar.css">
</head>
<body>
  <header class="site-topbar">
    <a href="/index.html" class="site-logo" aria-label="Dcout 메인으로 이동">
      <span class="logo-accent">DC</span>
      <span class="logo-divider" aria-hidden="true"></span>
      <span class="logo-rest">OUT</span>
    </a>
  </header>

  <h1>게시판</h1>

  <!-- 글쓰기 폼 -->
  <div id="postForm">
    <input type="text" id="titleInput" placeholder="제목" maxlength="50">
    <textarea id="contentInput" placeholder="내용을 입력하세요..." maxlength="1000"></textarea>
    
    <!-- 이미지/파일 추가 버튼 (위치 변경) -->
    <div class="image-upload-container">
      <div id="imagePreviewContainer"></div>
      <label for="imageUpload" class="image-upload-wrapper">
        <div id="uploadButton" class="image-upload-btn">
          <span class="upload-icon">🖼️</span>
          <span class="upload-text">이미지/파일 추가</span>
        </div>
      </label>
      <input type="file" id="imageUpload" multiple accept="image/*, .pdf, .doc, .docx, .xls, .xlsx, .ppt, .pptx, .hwp, .zip" style="display: none;">
    </div>

    <button id="submitBtn">글쓰기</button>
  </div>

  <!-- 공지사항 목록 컨테이너 추가 -->
  <div id="noticePosts"></div>
  <!-- 게시글 목록 (위로 이동) -->
  <div id="posts"></div>

  <!-- 검색 및 컨트롤 영역 (아래로 이동) -->
  <div id="controlsContainer">
    <div class="search-container">
      <select id="searchType">
        <option value="all">전체</option>
        <option value="title">제목</option>
        <option value="content">내용</option>
        <option value="user">작성자</option>
      </select>
      <input type="text" id="searchInput" placeholder="검색어를 입력하세요...">
      <button id="searchBtn">검색</button>
    </div>
    <div class="view-options">
      <select id="postsPerPage">
        <option value="10">10개씩 보기</option>
        <option value="20">20개씩 보기</option>
        <option value="30">30개씩 보기</option>
        <option value="40">40개씩 보기</option>
        <option value="50">50개씩 보기</option>
      </select>
    </div>
  </div>

  <!-- 페이지네이션 (아래로 이동) -->
  <div id="pagination"></div>

  <!-- 이미지 모달 -->
  <div id="imageModal" class="image-modal">
    <span class="image-modal-close">&times;</span>
    <img id="modalImage" class="image-modal-content" src="" alt="확대 이미지">
  </div>

  <!-- 알림 팝업 -->
  <div id="notification" class="notification-popup"></div>

  <!-- 확인 팝업 -->
  <div id="confirmModal" class="confirm-modal-overlay">
    <div class="confirm-modal">
      <p id="confirmMessage"></p>
      <div class="confirm-buttons">
        <button id="confirmYes">예</button>
        <button id="confirmNo">아니오</button>
      </div>
    </div>
  </div>

  <script>
    // --- 상태 관리 변수 ---
    let currentPage = 1;
    let postsPerPage = 10;
    let currentSearchQuery = '';
    let currentSearchType = 'all';
    let blockedUserIds = new Set();

    // --- DOM 요소 ---
    const token = localStorage.getItem("token");
    if (!token) {
      alert("로그인 후 이용하세요!");
      window.location.href = "login.html";
    }
    
    const postsDiv = document.getElementById("posts");
    const noticePostsDiv = document.getElementById("noticePosts"); // 공지사항 div
    const searchInput = document.getElementById('searchInput');
    const searchTypeSelect = document.getElementById('searchType');
    const searchBtn = document.getElementById('searchBtn');
    const postsPerPageSelect = document.getElementById('postsPerPage');
    const paginationDiv = document.getElementById('pagination');
    const submitBtn = document.getElementById('submitBtn');
    const titleInput = document.getElementById('titleInput');
    const contentInput = document.getElementById('contentInput');

    async function loadBlockedUsers() {
      try {
        const response = await fetch('/api/users/blocks', {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + token },
          credentials: 'same-origin'
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload?.error || '차단 목록을 불러오지 못했습니다.');
        }

        const blocks = Array.isArray(payload.blocks) ? payload.blocks : [];
        blockedUserIds = new Set(blocks.map((block) => block.id));
      } catch (error) {
        console.warn('[posts] loadBlockedUsers failed', error);
        blockedUserIds = blockedUserIds || new Set();
      }
    }

    // --- 데이터 로딩 및 렌더링 (수정) ---
    async function loadPosts() {
      postsDiv.innerHTML = "로딩 중...";
      noticePostsDiv.innerHTML = ""; // 공지사항 초기화
      try {
        const url = `/api/posts?page=${currentPage}&limit=${postsPerPage}&searchQuery=${encodeURIComponent(currentSearchQuery)}&searchType=${currentSearchType}`;
        const res = await fetch(url, { headers: { "Authorization": "Bearer " + token } });

        if (res.status === 401) {
          showNotification("로그인이 만료되었습니다. 다시 로그인해주세요.", "error");
          setTimeout(() => window.location.href = "login.html", 2000);
          return;
        }

        const data = await res.json();
        postsDiv.innerHTML = "";

        // 공지사항 렌더링
        if (data.notices && data.notices.length > 0) {
          data.notices.forEach(post => renderPost(post, true));
        }

        // 일반 게시글 렌더링
        if (data.posts && data.posts.length > 0) {
          data.posts.forEach(post => renderPost(post, false));
        } else if (data.notices.length === 0) {
          postsDiv.innerHTML = "<p>게시글이 없습니다.</p>";
        }
        renderPagination(data.totalPages, data.currentPage);

      } catch (err) {
        console.error("게시글 로딩 오류:", err);
        showNotification("게시글을 불러오는 중 오류가 발생했습니다.", "error");
      }
    }

    function renderPagination(totalPages, currentPage) {
      paginationDiv.innerHTML = '';
      if (totalPages <= 1) return;

      const createPageButton = (page, text = page) => {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'page-number';
        if (page === currentPage) {
          btn.classList.add('active');
        }
        btn.onclick = () => {
          if (page !== '...') {
            currentPage = page;
            loadPosts();
          }
        };
        return btn;
      };

      // 이전 버튼
      const prevBtn = createPageButton(currentPage - 1, '이전');
      prevBtn.disabled = currentPage === 1;
      paginationDiv.appendChild(prevBtn);

      const pageNumbers = [];
      if (totalPages <= 7) {
        for (let i = 1; i <= totalPages; i++) {
          pageNumbers.push(i);
        }
      } else {
        pageNumbers.push(1);
        if (currentPage > 3) pageNumbers.push('...');
        
        let start = Math.max(2, currentPage - 1);
        let end = Math.min(totalPages - 1, currentPage + 1);

        if (currentPage <= 3) {
          start = 2;
          end = 4;
        }
        if (currentPage >= totalPages - 2) {
          start = totalPages - 3;
          end = totalPages - 1;
        }

        for (let i = start; i <= end; i++) {
          pageNumbers.push(i);
        }

        if (currentPage < totalPages - 2) pageNumbers.push('...');
        pageNumbers.push(totalPages);
      }

      pageNumbers.forEach(num => {
        paginationDiv.appendChild(createPageButton(num));
      });

      // 다음 버튼
      const nextBtn = createPageButton(currentPage + 1, '다음');
      nextBtn.disabled = currentPage === totalPages;
      paginationDiv.appendChild(nextBtn);
    }

    // --- 게시글 렌더링 함수 (수정) ---
    function renderPost(post, isNotice) {
      const div = document.createElement("div");
      div.className = "post-box";
      if (isNotice) {
        div.classList.add("notice");
      }
      div.dataset.id = post._id;

      // post.author가 null일 경우를 대비하여 안전하게 photo 값을 가져오도록 수정합니다.
      const userPhoto = (post.author && post.author.photo) ? post.author.photo : "";
      const attachmentIcon = (post.images && post.images.length > 0) ? ' 📎' : '';
      const noticeBadge = isNotice ? '<span style="color:var(--primary-color); font-weight:bold;">[공지]</span> ' : '';
      
      div.innerHTML = `
        <div class="post-meta">
          ${getProfileImg(userPhoto)}
          <span class="post-username">${post.user}</span>
          <span class="post-date">${new Date(post.time).toLocaleDateString()}</span>
        </div>
        <div class="post-title">${noticeBadge}${post.title}${attachmentIcon}</div>
        <div class="post-content-preview">${post.content}</div>
      `;

      const authorRef = post?.author && typeof post.author === 'object' ? (post.author._id || post.author.id) : post?.author;
      const authorId = authorRef ? String(authorRef) : null;
      const me = parseJwt(token)?.username;

      if (authorId && post.user !== me) {
        const metaRow = div.querySelector('.post-meta');
        if (metaRow) {
          const blockWrapper = document.createElement('div');
          blockWrapper.className = 'post-meta-actions';
          const blockBtn = document.createElement('button');
          blockBtn.type = 'button';
          blockBtn.className = 'block-user-btn';
          const isBlocked = blockedUserIds.has(authorId);
          blockBtn.textContent = isBlocked ? '차단 해제' : '차단';
          blockBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            toggleBlockUser(authorId, post.user, !isBlocked);
          });
          blockWrapper.appendChild(blockBtn);
          metaRow.appendChild(blockWrapper);
        }
      }


      if (post.user === me) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'post-actions';
        actionsDiv.innerHTML = `<button class="edit-btn">수정</button><button class="delete-btn">삭제</button>`;
        div.appendChild(actionsDiv);
      }
      
      // 공지사항은 noticePostsDiv에, 일반글은 postsDiv에 추가
      if (isNotice) {
        noticePostsDiv.appendChild(div);
      } else {
        postsDiv.appendChild(div);
      }
    }

    async function toggleBlockUser(userId, username = '', shouldBlock) {
      if (!userId) return;
      const targetId = String(userId);
      const desiredBlock = typeof shouldBlock === 'boolean' ? shouldBlock : !blockedUserIds.has(targetId);
      try {
        let response;
        if (desiredBlock) {
          response = await fetch('/api/users/blocks', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            credentials: 'same-origin',
            body: JSON.stringify({ userId: targetId })
          });
        } else {
          response = await fetch(`/api/users/blocks/${targetId}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token },
            credentials: 'same-origin'
          });
        }

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload?.error || (desiredBlock ? '사용자를 차단하지 못했습니다.' : '차단을 해제하지 못했습니다.'));
        }

        await loadBlockedUsers();
        await loadPosts();

        const label = username ? `${username}님을 ` : '';
        showNotification(`${label}${desiredBlock ? '차단했습니다.' : '차단을 해제했습니다.'}`, 'success');
      } catch (error) {
        console.error('[posts] toggleBlockUser error', error);
        showNotification(error.message || '요청을 처리하지 못했습니다.', 'error');
      }
    }

    // --- 확인 팝업(모달) 함수 ---
    function showConfirm(message) {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirmModal');
        document.getElementById('confirmMessage').textContent = message;
        modal.classList.add('show');

        document.getElementById('confirmYes').onclick = () => {
          modal.classList.remove('show');
          resolve(true);
        };
        document.getElementById('confirmNo').onclick = () => {
          modal.classList.remove('show');
          resolve(false);
        };
      });
    }

    // --- 게시글 수정 및 삭제 ---
    async function deletePost(id) {
      const confirmed = await showConfirm("정말로 이 게시글을 삭제하시겠습니까?");
      if (confirmed) {
        try {
          const res = await fetch(`/api/posts/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
          });
          if (res.ok) {
            loadPosts(); // 목록 새로고침
          } else {
            alert("삭제에 실패했습니다.");
          }
        } catch (err) {
          alert("삭제 중 오류가 발생했습니다.");
        }
      }
    }

    // --- 이벤트 리스너 ---
    postsDiv.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-btn')) {
        const postBox = e.target.closest('.post-box');
        deletePost(postBox.dataset.id);
      } else if (e.target.classList.contains('edit-btn')) {
        // 수정 기능은 board.html로 이동하여 처리
        const postBox = e.target.closest('.post-box');
        window.location.href = `board.html?id=${postBox.dataset.id}`;
      } else if (e.target.closest('.post-box')) {
        // 게시글 클릭 시 상세 페이지로 이동
        const postBox = e.target.closest('.post-box');
        window.location.href = `board.html?id=${postBox.dataset.id}`;
      }
    });

    // --- 글쓰기 로직 (수정) ---
    submitBtn.addEventListener('click', async () => {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();

      if (!title) {
        alert("제목을 입력해주세요.");
        titleInput.focus();
        return;
      }
      if (!content) {
        alert("내용을 입력해주세요.");
        contentInput.focus();
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "등록 중...";

      try {
        // 1. 이미지/파일 업로드
        const imagePaths = [];
        for (const file of uploadedFiles) {
          const path = await handleFileUpload(file);
          if (path) {
            imagePaths.push(path);
          }
        }

        // 2. 게시글 데이터 전송
        const res = await fetch("/api/posts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token,
          },
          body: JSON.stringify({ title, content, images: imagePaths }),
        });

        if (res.ok) {
          // 입력 필드 초기화
          titleInput.value = "";
          contentInput.value = "";
          uploadedFiles = [];
          imagePreviewContainer.innerHTML = "";
          updateImagePreviewVisibility();
          
          // 목록 새로고침
          currentPage = 1; // 첫 페이지로 이동
          loadPosts();
          alert("글이 성공적으로 등록되었습니다.");
        } else {
          const errorData = await res.json();
          alert(`글 등록에 실패했습니다: ${errorData.error}`);
        }
      } catch (err) {
        alert(`글 등록 중 오류가 발생했습니다: ${err.message}`);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "글쓰기";
      }
    });
    
    // 검색, 페이지네이션 관련 이벤트 리스너는 기존과 동일
    searchInput.addEventListener('input', (e) => {
      if (e.target.value.trim() === '' && currentSearchQuery !== '') {
        currentSearchQuery = '';
        currentPage = 1;
        loadPosts();
      }
    });
    searchBtn.addEventListener('click', () => {
      currentPage = 1;
      currentSearchQuery = searchInput.value;
      currentSearchType = searchTypeSelect.value;
      loadPosts();
    });
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') searchBtn.click();
    });
    postsPerPageSelect.addEventListener('change', (e) => {
      currentPage = 1;
      postsPerPage = parseInt(e.target.value);
      loadPosts();
    });

    // --- 유틸리티 함수 ---
    function parseJwt(token) {
      try { return JSON.parse(atob(token.split('.')[1])); }
      catch (e) { return null; }
    }

    function getProfileImg(photo) {
      if (photo && photo !== "") {
        return `<img class="profile-thumb" src="${photo}" alt="프로필">`;
      } else {
        return `<span class="profile-thumb default">
          <svg width="26" height="26" viewBox="0 0 38 38"><circle cx="19" cy="19" r="19" fill="#e0e7ef"/><circle cx="19" cy="15" r="9" fill="#b6d0f7"/><ellipse cx="19" cy="30" rx="13" ry="7" fill="#b6d0f7"/><circle cx="19" cy="15" r="6" fill="#fff"/><ellipse cx="19" cy="30" rx="9" ry="4" fill="#fff"/></svg>
        </span>`;
      }
    }
    
    // --- 이미지/파일 업로드 및 미리보기 관련 함수들 ---
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imageUploadInput = document.getElementById('imageUpload');
    let uploadedFiles = [];

    function updateImagePreviewVisibility() {
      imagePreviewContainer.style.display = imagePreviewContainer.children.length > 0 ? 'grid' : 'none';
    }

    imageUploadInput.addEventListener('change', (event) => {
      const files = Array.from(event.target.files);
      files.forEach(file => {
        if (!uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
          uploadedFiles.push(file);
          addImagePreview(file);
        }
      });
      event.target.value = '';
    });

    function addImagePreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const previewDiv = document.createElement('div');
        previewDiv.className = 'image-preview';
        const isImage = file.type.startsWith('image/');
        previewDiv.innerHTML = `
          ${isImage ? `<img src="${e.target.result}" alt="${file.name}">` : `<div class="file-icon">📄</div>`}
          <div class="image-preview-name">${file.name}</div>
          <button class="image-remove-btn">&times;</button>
        `;
        previewDiv.querySelector('.image-remove-btn').onclick = () => removeImage(file.name, file.size, previewDiv);
        imagePreviewContainer.appendChild(previewDiv);
        updateImagePreviewVisibility();
      };
      reader.readAsDataURL(file);
    }

    function removeImage(fileName, fileSize, previewElement) {
      uploadedFiles = uploadedFiles.filter(f => !(f.name === fileName && f.size === fileSize));
      previewElement.remove();
      updateImagePreviewVisibility();
    }

    // 파일 업로드 처리 함수 (추가)
    async function handleFileUpload(file) {
      const formData = new FormData();
      formData.append('image', file);

      try {
        const res = await fetch('/api/posts/upload-image', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token },
          body: formData,
        });
        if (!res.ok) throw new Error('파일 업로드 실패');
        const data = await res.json();
        return data.imagePath;
      } catch (err) {
        console.error('Upload error:', err);
        alert(`${file.name} 업로드 중 오류 발생: ${err.message}`);
        return null;
      }
    }

    // --- 초기 로드 ---
    (async function initializeBoard() {
      await loadBlockedUsers();
      await loadPosts();
    })();
    
    // 알림 표시 기능 (누락 방지)
    function showNotification(message, type = "error") {
      const notification = document.getElementById("notification");
      notification.className = `notification-popup ${type}`;
      notification.innerHTML = `
        <button class="close-btn">&times;</button>
        <span class="notification-icon">${type === "error" ? "❌" : type === "success" ? "✅" : "⚠️"}</span>
        ${message}
      `;
      notification.classList.add("show");
      
      // 닫기 버튼
      const closeBtn = notification.querySelector(".close-btn");
      closeBtn.addEventListener("click", () => {
        notification.classList.remove("show");
      });
      
      // 자동 닫힘
      setTimeout(() => {
        notification.classList.remove("show");
      }, 5000);
    }
  </script>
</body>
</html>
