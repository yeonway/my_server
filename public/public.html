<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>전체 게시글</title>
  <script src="js/theme.js"></script>
  <link rel="stylesheet" href="css/topbar.css">
  <link rel="stylesheet" href="css/site-menu.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/notifications.css">
  <link rel="stylesheet" href="css/profile-menu.css">
  <link rel="stylesheet" href="css/dark-mode.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f8fafc;
    }
    .posts-stage {
      max-width: 900px;
      margin: 0 auto 60px;
      padding: 0 20px 40px;
    }
    .post-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
      padding: 20px 24px;
      margin-bottom: 18px;
      border: 1px solid #e2e8f0;
    }
    .post-card h3 {
      margin: 0 0 10px 0;
      color: #1f2937;
      font-size: 1.2rem;
    }
    .post-card p {
      margin: 0 0 12px 0;
      color: #475569;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .post-meta {
      font-size: 0.85rem;
      color: #64748b;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .post-actions {
      margin-top: 14px;
      display: flex;
      gap: 10px;
    }
    .post-actions button {
      padding: 8px 14px;
      border: 1px solid #cbd5f5;
      border-radius: 6px;
      background: #e0e7ff;
      color: #1e3a8a;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .post-actions button:hover {
      background: #c7d2fe;
    }
  </style>
  <script defer src="js/auth-helper.js"></script>
  <link rel="stylesheet" href="css/mobile-responsive.css">
</head>
<body>
  <header class="site-topbar">
    <a href="/index.html" class="site-logo" aria-label="DCOUT 홈으로 이동">
      <span class="logo-accent">DC</span>
      <span class="logo-divider" aria-hidden="true"></span>
      <span class="logo-rest">OUT</span>
    </a>
  </header>

  <main class="posts-stage">
    <div id="posts"></div>
  </main>

  <script>
    const token = localStorage.getItem('token');
    const username = token ? (() => {
      try {
        return JSON.parse(atob(token.split('.')[1])).username;
      } catch (err) {
        console.warn('토큰 파싱 실패', err);
        return null;
      }
    })() : null;

    function escapeHtml(str = '') {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    async function loadPosts() {
      try {
        const res = await fetch('/api/posts');
        if (!res.ok) throw new Error('게시글을 불러오지 못했습니다.');
        const posts = await res.json();
        const postsDiv = document.getElementById('posts');
        postsDiv.innerHTML = '';

        if (!Array.isArray(posts) || posts.length === 0) {
          postsDiv.innerHTML = '<p style="color:#64748b; text-align:center;">표시할 게시글이 없습니다.</p>';
          return;
        }

        posts.forEach(post => {
          const card = document.createElement('article');
          card.className = 'post-card';
          const safeTitle = escapeHtml(post.title || '제목 없음');
          const safeContent = escapeHtml(post.content || '내용이 없습니다.');
          const safeUser = escapeHtml(post.user || '알 수 없음');
          const timestamp = post.time ? new Date(post.time).toLocaleString() : '시간 정보 없음';

          card.innerHTML = `
            <h3>${safeTitle}</h3>
            <p>${safeContent}</p>
            <div class="post-meta">
              <span>작성자: ${safeUser}</span>
              <span>${timestamp}</span>
            </div>
          `;

          if (post.user && post.user === username) {
            const actions = document.createElement('div');
            actions.className = 'post-actions';
            actions.innerHTML = `
              <button type="button" data-action="edit" data-id="${post._id}">수정</button>
              <button type="button" data-action="delete" data-id="${post._id}">삭제</button>
            `;
            actions.addEventListener('click', (event) => handlePostAction(event));
            card.appendChild(actions);
          }

          postsDiv.appendChild(card);
        });
      } catch (error) {
        console.error(error);
        const postsDiv = document.getElementById('posts');
        postsDiv.innerHTML = '<p style="color:#dc2626; text-align:center;">게시글을 불러오는 중 오류가 발생했습니다.</p>';
      }
    }

    async function handlePostAction(event) {
      const target = event.target.closest('button[data-action]');
      if (!target) return;
      const postId = target.dataset.id;
      const action = target.dataset.action;
      if (action === 'delete') {
        await deletePost(postId);
      } else if (action === 'edit') {
        editPost(postId);
      }
    }

    async function deletePost(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      try {
        const res = await fetch(`/api/posts/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        alert(data.message || data.error || '삭제 결과를 확인할 수 없습니다.');
        await loadPosts();
      } catch (error) {
        alert('게시글 삭제 중 오류가 발생했습니다.');
        console.error(error);
      }
    }

    function editPost(id) {
      alert('게시글 수정 기능은 아직 준비 중입니다.');
    }

    loadPosts();
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script defer src="js/notifications.js"></script>
  <script defer src="js/profile-menu.js"></script>
  <script defer src="js/topbar-dock.js"></script>
</body>
</html>
