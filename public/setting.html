<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1f2937">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>설정</title>
  <script src="js/theme.js"></script>
  <script defer src="js/auth-helper.js"></script>
  <script defer src="js/blocking-client.js"></script>
  <script defer src="js/preferences-settings.js"></script>
  <link rel="stylesheet" href="css/setting.css">
  <link rel="stylesheet" href="css/topbar.css">
  <link rel="stylesheet" href="css/site-menu.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/notifications.css">
  <link rel="stylesheet" href="css/profile-menu.css">
  <link rel="stylesheet" href="css/dark-mode.css">
</head>
<body>
  <header class="site-topbar">
    <a href="/index.html" class="site-logo" aria-label="DCOUT 홈으로 이동">
      <span class="logo-accent">DC</span>
      <span class="logo-divider" aria-hidden="true"></span>
      <span class="logo-rest">OUT</span>
    </a>
        <nav class="site-menu" aria-label="주요 메뉴">
      <a href="chat.html">채팅</a>
      <a href="posts.html">게시판</a>
      <a href="profile.html">프로필</a>
      <a href="inquiry.html">문의하기</a>
      <a href="setting.html">설정</a>
    </nav>
    <div class="topbar-actions">
      <span data-network-indicator>Online</span>
    </div>
  </header>

  <main class="setting-stage">
    <div class="container">
    <h1>설정</h1>

    <!-- 비밀번호 변경 -->
    <div class="setting-card">
      <h2>비밀번호 변경</h2>
      <div class="form-group">
        <label for="currentPassword">현재 비밀번호</label>
        <input type="password" id="currentPassword" required>
      </div>
      <div class="form-group">
        <label for="newPassword">새 비밀번호</label>
        <input type="password" id="newPassword" required>
      </div>
      <div class="form-group">
        <label for="confirmPassword">새 비밀번호 확인</label>
        <input type="password" id="confirmPassword" required>
      </div>
      <button class="btn btn-primary" onclick="changePassword()">비밀번호 변경</button>
    </div>

    <!-- 환경 개인화 -->
    <div class="setting-card" id="personalizationCard">
      <h2>환경 개인화</h2>
      <p class="setting-card-description">모든 기기에서 동일하게 적용될 화면 모드, 글꼴 크기, 포인트 색상을 선택하세요. 변경 사항은 즉시 미리보기로 확인할 수 있습니다.</p>

      <section aria-labelledby="themePreference" class="preference-section">
        <h3 id="themePreference" class="setting-subtitle">테마 모드</h3>
        <div class="theme-options" data-theme-options>
          <label class="theme-option">
            <input type="radio" name="theme" value="light" data-theme-option>
            <div class="theme-option-body">
              <span class="theme-option-title">라이트 모드</span>
              <span class="theme-option-meta">밝고 선명한 화면을 선호할 때</span>
            </div>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="dark" data-theme-option>
            <div class="theme-option-body">
              <span class="theme-option-title">다크 모드</span>
              <span class="theme-option-meta">야간과 장시간 사용에 적합</span>
            </div>
          </label>
          <label class="theme-option">
            <input type="radio" name="theme" value="system" data-theme-option>
            <div class="theme-option-body">
              <span class="theme-option-title">시스템과 동일</span>
              <span class="theme-option-meta">OS 설정에 따라 자동 전환</span>
            </div>
          </label>
        </div>
      </section>

      <section aria-labelledby="fontPreference" class="preference-section">
        <h3 id="fontPreference" class="setting-subtitle">글꼴 크기</h3>
        <div class="font-scale-buttons" data-font-scale-group>
          <button type="button" class="font-scale-button" data-font-scale="small">
            <span class="font-label">A-</span>
            <span class="font-caption">작게</span>
          </button>
          <button type="button" class="font-scale-button" data-font-scale="medium">
            <span class="font-label">A</span>
            <span class="font-caption">보통</span>
          </button>
          <button type="button" class="font-scale-button" data-font-scale="large">
            <span class="font-label">A+</span>
            <span class="font-caption">크게</span>
          </button>
          <button type="button" class="font-scale-button" data-font-scale="xlarge">
            <span class="font-label">A++</span>
            <span class="font-caption">아주 크게</span>
          </button>
        </div>
      </section>

      <section aria-labelledby="accentPreference" class="preference-section">
        <h3 id="accentPreference" class="setting-subtitle">컬러 테마</h3>
        <div class="accent-picker">
          <label for="accentColorPicker">사용자 지정 색상</label>
          <input type="color" id="accentColorPicker" class="accent-color-input" data-accent-input>
          <div class="accent-swatches" data-accent-swatches>
            <button type="button" class="accent-swatch" data-accent-swatch="#6366f1" style="--swatch-color:#6366f1" aria-label="보라"></button>
            <button type="button" class="accent-swatch" data-accent-swatch="#22d3ee" style="--swatch-color:#22d3ee" aria-label="민트"></button>
            <button type="button" class="accent-swatch" data-accent-swatch="#f97316" style="--swatch-color:#f97316" aria-label="오렌지"></button>
            <button type="button" class="accent-swatch" data-accent-swatch="#ec4899" style="--swatch-color:#ec4899" aria-label="핑크"></button>
            <button type="button" class="accent-swatch" data-accent-swatch="#10b981" style="--swatch-color:#10b981" aria-label="그린"></button>
            <button type="button" class="accent-swatch" data-accent-swatch="#facc15" style="--swatch-color:#facc15" aria-label="옐로우"></button>
            <button type="button" class="accent-swatch" data-accent-swatch="#0ea5e9" style="--swatch-color:#0ea5e9" aria-label="블루"></button>
            <button type="button" class="accent-swatch" data-accent-swatch="#f43f5e" style="--swatch-color:#f43f5e" aria-label="레드"></button>
          </div>
        </div>
      </section>

      <section class="preference-preview" data-preference-preview aria-live="polite">
        <div class="preference-preview-header">
          <span class="preference-preview-title">미리보기</span>
          <span class="preference-preview-meta"><span data-preview-theme-label></span> · <span data-preview-font-label></span></span>
        </div>
        <p data-preview-text>선택한 스타일이 이렇게 보입니다. 새로고침 없이도 모든 페이지에 즉시 반영돼요.</p>
        <div class="preference-preview-actions" data-preview-actions></div>
        <span class="preference-preview-color">포인트 컬러 <strong data-preview-color></strong></span>
      </section>
    </div>

    <!-- 퀵 액션 & 단축키 -->
    <div class="setting-card" id="quickActionCard">
      <h2>퀵 액션 &amp; 단축키</h2>
      <p class="setting-card-description">자주 사용하는 기능을 퀵 액션 버튼과 단축키로 등록해 빠르게 이동하세요.</p>
      <ul class="quick-action-selector" data-quick-action-list></ul>
      <div class="shortcut-grid">
        <div class="shortcut-field">
          <label for="shortcutQuickMenu">퀵 액션 메뉴</label>
          <input type="text" id="shortcutQuickMenu" class="shortcut-input" data-shortcut-input="openQuickActions" placeholder="Ctrl+K">
        </div>
        <div class="shortcut-field">
          <label for="shortcutToggleTheme">테마 전환</label>
          <input type="text" id="shortcutToggleTheme" class="shortcut-input" data-shortcut-input="toggleTheme" placeholder="Shift+D">
        </div>
      </div>
      <p class="shortcut-hint">입력 칸에서 원하는 키 조합을 누르면 즉시 기록됩니다. Backspace로 기본값으로 되돌릴 수 있습니다.</p>
      <div class="quick-action-tip"><strong>TIP</strong> 퀵 액션은 우측 하단 번개 버튼과 <kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>K</kbd> 단축키로 언제든 열 수 있습니다.</div>
    </div>

    <!-- 차단 사용자 관리 -->
    <div class="setting-card" id="blockedUsersCard">
      <h2>차단 사용자</h2>
      <p class="setting-card-description">신고나 차단으로 숨긴 사용자를 확인하고 차단을 해제할 수 있습니다.</p>
      <div id="blockedUsersLoading" class="blocked-users-loading">차단한 사용자를 불러오는 중...</div>
      <ul id="blockedUsersList" class="blocked-users-list"></ul>
      <div id="blockedUsersEmpty" class="blocked-users-empty" hidden>차단한 사용자가 없습니다.</div>
      <div id="blockedUsersError" class="blocked-users-error" hidden></div>
    </div>

    <!-- 회원 탈퇴 -->
    <div class="setting-card">
      <h2>회원 탈퇴</h2>
      <p>계정을 영구적으로 삭제합니다. 이 작업은 되돌릴 수 없습니다.</p>
      <button class="btn btn-danger" onclick="openDeleteModal()">회원 탈퇴</button>
    </div>
  </div>

  <!-- 회원 탈퇴 확인 모달 -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
      <h3>정말로 탈퇴하시겠습니까?</h3>
      <p>계정을 삭제하려면 비밀번호를 입력하세요.</p>
      <div class="form-group">
        <input type="password" id="deleteConfirmPassword" placeholder="비밀번호 확인">
      </div>
      <div class="modal-buttons">
        <button class="btn" onclick="closeDeleteModal()">취소</button>
        <button class="btn btn-danger" onclick="deleteAccount()">탈퇴 확인</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      alert("로그인이 필요합니다.");
      window.location.href = "/login.html";
    }

    const blockedUsersList = document.getElementById('blockedUsersList');
    const blockedUsersEmpty = document.getElementById('blockedUsersEmpty');
    const blockedUsersLoading = document.getElementById('blockedUsersLoading');
    const blockedUsersError = document.getElementById('blockedUsersError');

    let detachBlockSubscription = null;

    function resolvePhotoUrl(photo) {
      if (!photo || typeof photo !== 'string') return null;
      if (/^https?:/i.test(photo)) return photo;
      const normalized = photo.startsWith('/') ? photo : `/${photo.replace(/^\/+/,'')}`;
      return normalized;
    }

    function subscribeToBlockUpdates() {
      if (!window.BlockingClient) {
        if (blockedUsersError) {
          blockedUsersError.hidden = false;
          blockedUsersError.textContent = '차단 정보를 불러올 수 없습니다.';
        }
        return;
      }

      if (typeof detachBlockSubscription === 'function') {
        detachBlockSubscription();
      }

      detachBlockSubscription = window.BlockingClient.subscribe((blocks) => {
        if (blockedUsersLoading) blockedUsersLoading.hidden = true;
        if (blockedUsersError) {
          blockedUsersError.hidden = true;
          blockedUsersError.textContent = '';
        }
        renderBlockedUsers(Array.isArray(blocks) ? blocks : []);
      });
    }

    async function requestUnblock(userId) {
      if (!userId) {
        throw new Error('차단 해제 대상이 올바르지 않습니다.');
      }

      if (!window.BlockingClient) {
        throw new Error('차단 정보를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.');
      }

      await window.BlockingClient.unblock(userId, { token });
    }

    function renderBlockedUsers(blocks = []) {
      if (!blockedUsersList) return;

      blockedUsersList.innerHTML = '';

      if (!Array.isArray(blocks) || blocks.length === 0) {
        if (blockedUsersEmpty) blockedUsersEmpty.hidden = false;
        return;
      }

      if (blockedUsersEmpty) blockedUsersEmpty.hidden = true;

      blocks.forEach((block) => {
        const item = document.createElement('li');
        item.className = 'blocked-user-item';

        const info = document.createElement('div');
        info.className = 'blocked-user-info';

        const avatar = document.createElement('div');
        avatar.className = 'blocked-user-avatar';
        const photoUrl = resolvePhotoUrl(block.photo);
        if (photoUrl) {
          const img = document.createElement('img');
          img.src = photoUrl;
          img.alt = `${block.username || '차단 사용자'} 프로필 사진`;
          avatar.appendChild(img);
        } else {
          const initial = (block.username || block.name || '?').trim().charAt(0) || '?';
          avatar.textContent = initial.toUpperCase();
        }

        const textWrap = document.createElement('div');
        textWrap.className = 'blocked-user-text';

        const nameEl = document.createElement('span');
        nameEl.className = 'blocked-user-name';
        nameEl.textContent = block.name || block.username || '알 수 없는 사용자';

        const usernameEl = document.createElement('span');
        usernameEl.className = 'blocked-user-username';
        usernameEl.textContent = block.username ? `@${block.username}` : '';

        textWrap.appendChild(nameEl);
        textWrap.appendChild(usernameEl);

        info.appendChild(avatar);
        info.appendChild(textWrap);

        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-secondary unblock-btn';
        button.textContent = '차단 해제';

        button.addEventListener('click', async () => {
          if (!block?.id) return;
          const originalText = button.textContent;
          button.disabled = true;
          button.textContent = '해제 중...';
          try {
            await requestUnblock(block.id);
            const label = block.username ? `${block.username}님` : '해당 사용자';
            alert(`${label}의 차단을 해제했습니다.`);
          } catch (error) {
            alert(error.message || '차단 해제에 실패했습니다.');
          } finally {
            button.disabled = false;
            button.textContent = originalText;
          }
        });

        item.appendChild(info);
        item.appendChild(button);
        blockedUsersList.appendChild(item);
      });
    }

    async function refreshBlockedUsers() {
      if (!blockedUsersList || !window.BlockingClient) return;

      if (blockedUsersLoading) blockedUsersLoading.hidden = false;
      if (blockedUsersError) {
        blockedUsersError.hidden = true;
        blockedUsersError.textContent = '';
      }
      if (blockedUsersEmpty) blockedUsersEmpty.hidden = true;

      try {
        await window.BlockingClient.refresh({ token });
      } catch (error) {
        if (blockedUsersError) {
          blockedUsersError.hidden = false;
          blockedUsersError.textContent = error.message || '차단 목록을 불러오지 못했습니다.';
        }
      } finally {
        if (blockedUsersLoading) blockedUsersLoading.hidden = true;
        if (blockedUsersError && !blockedUsersError.hidden) {
          return;
        }
        const currentBlocks = window.BlockingClient.getBlocks ? window.BlockingClient.getBlocks() : [];
        if ((!currentBlocks || currentBlocks.length === 0) && blockedUsersList.children.length === 0 && blockedUsersEmpty) {
          blockedUsersEmpty.hidden = false;
        }
      }
    }

    // 테마 설정 로직
    const themeRadios = document.querySelectorAll('input[name="theme"]');
    const syncThemeSelection = (theme) => {
      const target = document.querySelector(`input[name="theme"][value="${theme}"]`);
      if (target) {
        target.checked = true;
        return;
      }
      const fallbackRadio = document.querySelector('input[name="theme"][value="system"]');
      if (fallbackRadio) {
        fallbackRadio.checked = true;
      }
    };
    themeRadios.forEach((radio) => {
      radio.addEventListener('change', (event) => {
        const chosen = event.target.value;
        if (window.ThemeManager && typeof window.ThemeManager.setTheme === 'function') {
          window.ThemeManager.setTheme(chosen);
        } else {
          localStorage.setItem('theme', chosen);
        }
      });
    });
    if (window.ThemeManager && typeof window.ThemeManager.subscribe === 'function') {
      window.ThemeManager.subscribe((theme) => {
        syncThemeSelection(theme);
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      const manager = window.ThemeManager;
      const savedTheme = manager && typeof manager.getTheme === 'function'
        ? manager.getTheme()
        : (localStorage.getItem('theme') || 'system');
      syncThemeSelection(savedTheme);
      subscribeToBlockUpdates();
      if (token) {
        refreshBlockedUsers();
      }
    });

    // 비밀번호 변경 로직
    async function changePassword() {
      const currentPassword = document.getElementById('currentPassword').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();

      if (!currentPassword || !newPassword || !confirmPassword) {
        alert("모든 필드를 입력해주세요.");
        return;
      }
      if (newPassword.length < 6) {
        alert("새 비밀번호는 6자 이상이어야 합니다.");
        return;
      }
      if (currentPassword === newPassword) {
        alert("새 비밀번호는 현재 비밀번호와 달라야 합니다.");
        return;
      }
      if (newPassword !== confirmPassword) {
        alert("새 비밀번호가 일치하지 않습니다.");
        return;
      }

      try {
        const res = await fetch('/api/settings/password', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        alert("비밀번호가 성공적으로 변경되었습니다.");
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      } catch (err) {
        alert(err.message || "비밀번호 변경에 실패했습니다.");
      }
    }

    // 회원 탈퇴 로직
    const deleteModal = document.getElementById('deleteModal');
    function openDeleteModal() { deleteModal.classList.add('show'); }
    function closeDeleteModal() { deleteModal.classList.remove('show'); }
    async function deleteAccount() {
      const password = document.getElementById('deleteConfirmPassword').value.trim();
      if (!password) {
        alert("비밀번호를 입력해주세요.");
        return;
      }
      try {
        const res = await fetch('/api/settings', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        alert("회원 탈퇴가 완료되었습니다.");
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      } catch (err) {
        alert(err.message || "회원 탈퇴에 실패했습니다.");
      }
    }

  </script>
  </main>
  <script src="/socket.io/socket.io.js"></script>
  <script defer src="js/notifications.js"></script>
  <script defer src="js/profile-menu.js"></script>
  <script defer src="js/pwa.js"></script>
  <script defer src="js/topbar-dock.js"></script>
</body>
</html>
