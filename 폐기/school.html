<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>학교 급식 & 시간표 조회</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans KR", sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #2c3e50; }
    .container { max-width: 900px; margin: 0 auto; }
    .section { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 6px 0; padding: 6px; border-bottom: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #f4f6f7; }
    .controls { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
    select, button, input { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    button { background: #3498db; color: white; cursor: pointer; border-color: #3498db; }
    button:hover { background: #2980b9; }
    .school-search-form { display: flex; gap: 10px; margin-bottom: 20px; }
    .school-search-form input { flex-grow: 1; }
    .info-container { display: none; } /* 정보 컨테이너 기본 숨김 */
    .loading-text, .error-text { color: #888; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏫 학교 급식 & 시간표 조회</h1>

    <div class="school-search-form">
      <input type="text" id="schoolNameInput" placeholder="학교 전체 이름을 입력하세요 (예: 세화고등학교)">
      <button id="searchBtn">조회</button>
    </div>

    <div id="infoContainer" class="info-container">
      <div id="mealSection" class="section">
        <h2>🍚 급식</h2>
        <ul id="mealList"></ul>
      </div>
      <div id="timetableSection" class="section">
        <!-- 시간표 내용은 JS로 채워짐 -->
      </div>
    </div>
  </div>

  <script>
    const schoolNameInput = document.getElementById('schoolNameInput');
    const searchBtn = document.getElementById('searchBtn');
    const infoContainer = document.getElementById('infoContainer');
    const mealSection = document.getElementById('mealSection');
    const mealList = document.getElementById('mealList');
    const timetableSection = document.getElementById('timetableSection');

    let fullTimetable = {};

    // 조회 버튼 클릭 이벤트
    searchBtn.addEventListener('click', fetchData);
    schoolNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') fetchData();
    });

    // 페이지 로드 시 localStorage에 저장된 학교 이름으로 자동 조회
    document.addEventListener('DOMContentLoaded', () => {
      const savedSchool = localStorage.getItem('schoolName');
      if (savedSchool) {
        schoolNameInput.value = savedSchool;
        fetchData();
      }
    });

    // 데이터 조회 함수
    async function fetchData() {
      const schoolName = schoolNameInput.value.trim();
      if (!schoolName) {
        alert('학교 이름을 입력해주세요.');
        return;
      }

      // 이전 결과 초기화 및 로딩 상태 표시
      infoContainer.style.display = 'block';
      mealList.innerHTML = `<li class="loading-text">급식 정보 로딩 중...</li>`;
      timetableSection.innerHTML = `<h2>📅 오늘의 시간표</h2><p class="loading-text">시간표 정보 로딩 중...</p>`;
      
      // 학교 이름 저장
      localStorage.setItem('schoolName', schoolName);

      // 급식과 시간표 정보 병렬로 요청
      await Promise.all([
        loadMeal(schoolName),
        fetchFullTimetable(schoolName)
      ]);
    }

    // 급식 정보 불러오기
    async function loadMeal(schoolName) {
      try {
        const res = await fetch(`/api/school/meal?schoolName=${encodeURIComponent(schoolName)}`);
        const data = await res.json();
        mealList.innerHTML = "";

        if (!res.ok) throw new Error(data.error);

        if (!Array.isArray(data) || data.length === 0) {
          mealList.innerHTML = `<li>${data.meal || "오늘 급식 정보가 없습니다."}</li>`;
          return;
        }
        data.forEach(m => {
          const li = document.createElement("li");
          li.textContent = `[${m.mealName}] ${m.menu}`;
          mealList.appendChild(li);
        });
      } catch (err) {
        mealList.innerHTML = `<li class="error-text">급식 정보 로딩 실패: ${err.message}</li>`;
      }
    }

    // 시간표 정보 불러오기
    async function fetchFullTimetable(schoolName) {
      try {
        const res = await fetch(`/api/school/timetable?schoolName=${encodeURIComponent(schoolName)}`);
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error);
        
        fullTimetable = data;
        if (Object.keys(fullTimetable).length > 0) {
          timetableSection.innerHTML = `
            <h2>📅 오늘의 시간표</h2>
            <div class="controls">
              <label>학년: <select id="gradeSelect"></select></label>
              <label>반: <select id="classSelect"></select></label>
            </div>
            <table>
              <thead><tr><th>교시</th><th>과목</th></tr></thead>
              <tbody id="timetableBody"></tbody>
            </table>
          `;
          populateGradeSelect();
        } else {
          throw new Error('시간표 데이터가 없습니다.');
        }
      } catch (err) {
        timetableSection.innerHTML = `<h2>📅 오늘의 시간표</h2><p class="error-text">시간표 로딩 실패: ${err.message}</p>`;
      }
    }

    // --- 시간표 렌더링 관련 함수들 (기존과 거의 동일) ---
    function populateGradeSelect() {
      const gradeSelect = document.getElementById('gradeSelect');
      const grades = Object.keys(fullTimetable);
      gradeSelect.innerHTML = grades.map(g => `<option value="${g}">${g}학년</option>`).join('');
      gradeSelect.onchange = populateClassSelect;
      populateClassSelect();
    }

    function populateClassSelect() {
      const gradeSelect = document.getElementById('gradeSelect');
      const classSelect = document.getElementById('classSelect');
      const grade = gradeSelect.value;
      const classes = Object.keys(fullTimetable[grade] || {});
      classSelect.innerHTML = classes.map(c => `<option value="${c}">${c}반</option>`).join('');
      classSelect.onchange = renderTimetable;
      renderTimetable();
    }

    function renderTimetable() {
      const gradeSelect = document.getElementById('gradeSelect');
      const classSelect = document.getElementById('classSelect');
      const timetableBody = document.getElementById('timetableBody');
      const grade = gradeSelect.value;
      const classNum = classSelect.value;
      const day = new Date().getDay();

      if (day === 0 || day === 6 || !fullTimetable[grade] || !fullTimetable[grade][classNum]) {
        timetableBody.innerHTML = `<tr><td colspan="2">오늘은 수업이 없습니다.</td></tr>`;
        return;
      }
      const todayTimetable = fullTimetable[grade][classNum][day - 1] || [];
      timetableBody.innerHTML = todayTimetable.map((subject, index) => `
        <tr><td>${index + 1}교시</td><td>${subject || ''}</td></tr>
      `).join('');
    }
  </script>
</body>
</html>
