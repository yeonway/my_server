<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>í•™êµ ê¸‰ì‹ & ì‹œê°„í‘œ ì¡°íšŒ</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans KR", sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #2c3e50; }
    .container { max-width: 900px; margin: 0 auto; }
    .section { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 6px 0; padding: 6px; border-bottom: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #f4f6f7; }
    .controls { margin-bottom: 15px; display: flex; gap: 10px; align-items: center; }
    select, button, input { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    button { background: #3498db; color: white; cursor: pointer; border-color: #3498db; }
    button:hover { background: #2980b9; }
    .school-search-form { display: flex; gap: 10px; margin-bottom: 20px; }
    .school-search-form input { flex-grow: 1; }
    .info-container { display: none; } /* ì •ë³´ ì»¨í…Œì´ë„ˆ ê¸°ë³¸ ìˆ¨ê¹€ */
    .loading-text, .error-text { color: #888; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ« í•™êµ ê¸‰ì‹ & ì‹œê°„í‘œ ì¡°íšŒ</h1>

    <div class="school-search-form">
      <input type="text" id="schoolNameInput" placeholder="í•™êµ ì „ì²´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„¸í™”ê³ ë“±í•™êµ)">
      <button id="searchBtn">ì¡°íšŒ</button>
    </div>

    <div id="infoContainer" class="info-container">
      <div id="mealSection" class="section">
        <h2>ğŸš ê¸‰ì‹</h2>
        <ul id="mealList"></ul>
      </div>
      <div id="timetableSection" class="section">
        <!-- ì‹œê°„í‘œ ë‚´ìš©ì€ JSë¡œ ì±„ì›Œì§ -->
      </div>
    </div>
  </div>

  <script>
    const schoolNameInput = document.getElementById('schoolNameInput');
    const searchBtn = document.getElementById('searchBtn');
    const infoContainer = document.getElementById('infoContainer');
    const mealSection = document.getElementById('mealSection');
    const mealList = document.getElementById('mealList');
    const timetableSection = document.getElementById('timetableSection');

    let fullTimetable = {};

    // ì¡°íšŒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    searchBtn.addEventListener('click', fetchData);
    schoolNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') fetchData();
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì— ì €ì¥ëœ í•™êµ ì´ë¦„ìœ¼ë¡œ ìë™ ì¡°íšŒ
    document.addEventListener('DOMContentLoaded', () => {
      const savedSchool = localStorage.getItem('schoolName');
      if (savedSchool) {
        schoolNameInput.value = savedSchool;
        fetchData();
      }
    });

    // ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜
    async function fetchData() {
      const schoolName = schoolNameInput.value.trim();
      if (!schoolName) {
        alert('í•™êµ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™” ë° ë¡œë”© ìƒíƒœ í‘œì‹œ
      infoContainer.style.display = 'block';
      mealList.innerHTML = `<li class="loading-text">ê¸‰ì‹ ì •ë³´ ë¡œë”© ì¤‘...</li>`;
      timetableSection.innerHTML = `<h2>ğŸ“… ì˜¤ëŠ˜ì˜ ì‹œê°„í‘œ</h2><p class="loading-text">ì‹œê°„í‘œ ì •ë³´ ë¡œë”© ì¤‘...</p>`;
      
      // í•™êµ ì´ë¦„ ì €ì¥
      localStorage.setItem('schoolName', schoolName);

      // ê¸‰ì‹ê³¼ ì‹œê°„í‘œ ì •ë³´ ë³‘ë ¬ë¡œ ìš”ì²­
      await Promise.all([
        loadMeal(schoolName),
        fetchFullTimetable(schoolName)
      ]);
    }

    // ê¸‰ì‹ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMeal(schoolName) {
      try {
        const res = await fetch(`/api/school/meal?schoolName=${encodeURIComponent(schoolName)}`);
        const data = await res.json();
        mealList.innerHTML = "";

        if (!res.ok) throw new Error(data.error);

        if (!Array.isArray(data) || data.length === 0) {
          mealList.innerHTML = `<li>${data.meal || "ì˜¤ëŠ˜ ê¸‰ì‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."}</li>`;
          return;
        }
        data.forEach(m => {
          const li = document.createElement("li");
          li.textContent = `[${m.mealName}] ${m.menu}`;
          mealList.appendChild(li);
        });
      } catch (err) {
        mealList.innerHTML = `<li class="error-text">ê¸‰ì‹ ì •ë³´ ë¡œë”© ì‹¤íŒ¨: ${err.message}</li>`;
      }
    }

    // ì‹œê°„í‘œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    async function fetchFullTimetable(schoolName) {
      try {
        const res = await fetch(`/api/school/timetable?schoolName=${encodeURIComponent(schoolName)}`);
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error);
        
        fullTimetable = data;
        if (Object.keys(fullTimetable).length > 0) {
          timetableSection.innerHTML = `
            <h2>ğŸ“… ì˜¤ëŠ˜ì˜ ì‹œê°„í‘œ</h2>
            <div class="controls">
              <label>í•™ë…„: <select id="gradeSelect"></select></label>
              <label>ë°˜: <select id="classSelect"></select></label>
            </div>
            <table>
              <thead><tr><th>êµì‹œ</th><th>ê³¼ëª©</th></tr></thead>
              <tbody id="timetableBody"></tbody>
            </table>
          `;
          populateGradeSelect();
        } else {
          throw new Error('ì‹œê°„í‘œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        timetableSection.innerHTML = `<h2>ğŸ“… ì˜¤ëŠ˜ì˜ ì‹œê°„í‘œ</h2><p class="error-text">ì‹œê°„í‘œ ë¡œë”© ì‹¤íŒ¨: ${err.message}</p>`;
      }
    }

    // --- ì‹œê°„í‘œ ë Œë”ë§ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ê±°ì˜ ë™ì¼) ---
    function populateGradeSelect() {
      const gradeSelect = document.getElementById('gradeSelect');
      const grades = Object.keys(fullTimetable);
      gradeSelect.innerHTML = grades.map(g => `<option value="${g}">${g}í•™ë…„</option>`).join('');
      gradeSelect.onchange = populateClassSelect;
      populateClassSelect();
    }

    function populateClassSelect() {
      const gradeSelect = document.getElementById('gradeSelect');
      const classSelect = document.getElementById('classSelect');
      const grade = gradeSelect.value;
      const classes = Object.keys(fullTimetable[grade] || {});
      classSelect.innerHTML = classes.map(c => `<option value="${c}">${c}ë°˜</option>`).join('');
      classSelect.onchange = renderTimetable;
      renderTimetable();
    }

    function renderTimetable() {
      const gradeSelect = document.getElementById('gradeSelect');
      const classSelect = document.getElementById('classSelect');
      const timetableBody = document.getElementById('timetableBody');
      const grade = gradeSelect.value;
      const classNum = classSelect.value;
      const day = new Date().getDay();

      if (day === 0 || day === 6 || !fullTimetable[grade] || !fullTimetable[grade][classNum]) {
        timetableBody.innerHTML = `<tr><td colspan="2">ì˜¤ëŠ˜ì€ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }
      const todayTimetable = fullTimetable[grade][classNum][day - 1] || [];
      timetableBody.innerHTML = todayTimetable.map((subject, index) => `
        <tr><td>${index + 1}êµì‹œ</td><td>${subject || ''}</td></tr>
      `).join('');
    }
  </script>
</body>
</html>
